

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Testing &mdash; DeepPathway 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Usage" href="../Usage.html" />
    <link rel="prev" title="This tutorial provides the data processing of the ST datasets. Plase update and save the config.py file as following." href="data_processing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DeepPathway
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="data_processing.html">This tutorial provides the data processing of the ST datasets. Plase update and save the config.py file as following.</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Using-BLEEP+Optimus">Using BLEEP+Optimus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Using-DeepPathway">Using DeepPathway</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">README</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DeepPathway</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Testing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/training.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Add parent directory to Python path</span>
<span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/home/e90244aa/Bleep/DeepPathway/&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">parent_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_loaders</span><span class="p">,</span> <span class="n">build_loaders_inference</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BLEEPOnly</span><span class="p">,</span> <span class="n">BLEEPWithOptimus</span><span class="p">,</span> <span class="n">BLEEP_MLP</span><span class="p">,</span> <span class="n">DeepPathway</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">spatialdata</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_zarr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_sdata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/xarray_schema/__init__.py:1: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools&lt;81.
  from pkg_resources import DistributionNotFound, get_distribution
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py:2249: UnsupportedFieldAttributeWarning: The &#39;repr&#39; attribute with value False was provided to the `Field()` function, which has no effect in the context it was used. &#39;repr&#39; is field-specific metadata, and can only be attached to a model field using `Annotated` metadata or by assignment. This may have happened because an `Annotated` type alias using the `type` statement was used, or if the `Field()` function was attached to a single member of a union type.
  warnings.warn(
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py:2249: UnsupportedFieldAttributeWarning: The &#39;frozen&#39; attribute with value True was provided to the `Field()` function, which has no effect in the context it was used. &#39;frozen&#39; is field-specific metadata, and can only be attached to a model field using `Annotated` metadata or by assignment. This may have happened because an `Annotated` type alias using the `type` statement was used, or if the `Field()` function was attached to a single member of a union type.
  warnings.warn(
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Set seed for NumPy</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Set seed for PyTorch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Set seed for CUDA</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Ensure deterministic behavior in CUDA operations</span>
<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Set environment variable for Python hash</span>
<span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#newly added line</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUBLAS_WORKSPACE_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;:16:8&quot;</span> <span class="c1">#newly added line</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">loss_meter</span> <span class="o">=</span> <span class="n">AvgMeter</span><span class="p">()</span>
    <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm_object</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;reduced_expression&quot;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;pos encodings&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;st_feat&#39;</span><span class="p">}</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_meter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">tqdm_object</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">train_loss</span><span class="o">=</span><span class="n">loss_meter</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">get_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss_meter</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">):</span>
    <span class="n">loss_meter</span> <span class="o">=</span> <span class="n">AvgMeter</span><span class="p">()</span>
    <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm_object</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;reduced_expression&quot;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;pos encodings&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;st_feat&#39;</span><span class="p">}</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_meter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">tqdm_object</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">valid_loss</span><span class="o">=</span><span class="n">loss_meter</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss_meter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">tst_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">best_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">=</span><span class="n">BLEEPWithOptimus</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is BLEEP with Optimus using Image Encoder of ResNet18&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model is BLEEP with Optimus using Image Encoder of ResNet18
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished Loading Model.....:&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span><span class="o">=</span><span class="n">build_loaders</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">train_samples</span><span class="p">,</span><span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>
<span class="n">save_path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span> <span class="o">+</span> <span class="s2">&quot;saved_weights/itr_01&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span> <span class="o">+</span> <span class="s2">&quot;_pathways_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span>
<span class="n">early_stopping</span><span class="o">=</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">patience</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training Started of Model&quot;</span><span class="p">,</span><span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Finished Loading Model.....: Bleep+optimus
Building loaders
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
12616 3155
train/test split completed
Finished building loaders
Training Started of Model Bleep+optimus
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
    <span class="n">tr_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="n">test_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
        <span class="n">lss</span> <span class="o">=</span> <span class="n">test_loss</span><span class="o">.</span><span class="n">avg</span>
        <span class="n">tst_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lss</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lss</span> <span class="o">&lt;</span> <span class="n">best_loss</span><span class="p">:</span>
        <span class="n">best_loss</span> <span class="o">=</span> <span class="n">lss</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best loss at Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
    <span class="c1"># Early Stopping Check</span>
    <span class="n">early_stopping</span><span class="p">(</span><span class="n">lss</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">early_stopping</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Early stopping&quot;</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch: 1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.44it/s, lr=0.001, train_loss=22.8]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.70it/s, valid_loss=6.32]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 1
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.45it/s, lr=0.001, train_loss=15.5]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.51it/s, valid_loss=5.72]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 2
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 3
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=12.8]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.50it/s, valid_loss=5.35]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 3
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=11.4]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.55it/s, valid_loss=5.09]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 4
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=10.3]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.49it/s, valid_loss=4.88]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 5
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 6
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=9.56]
100%|███████████████████████████| 50/50 [00:07&lt;00:00,  6.53it/s, valid_loss=4.7]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 6
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=8.94]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.57it/s, valid_loss=4.54]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 7
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=8.43]
100%|███████████████████████████| 50/50 [00:07&lt;00:00,  6.60it/s, valid_loss=4.4]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 8
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=8]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.53it/s, valid_loss=4.27]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 9
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=7.62]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.60it/s, valid_loss=4.16]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 10
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 11
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=7.28]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.56it/s, valid_loss=4.06]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 11
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 12
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=6.99]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.52it/s, valid_loss=3.99]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 12
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 13
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.45it/s, lr=0.001, train_loss=6.73]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.49it/s, valid_loss=3.91]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 13
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 14
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=6.5]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.54it/s, valid_loss=3.85]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 14
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 15
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=6.3]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.55it/s, valid_loss=3.79]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 15
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 16
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=6.12]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.52it/s, valid_loss=3.74]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 16
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 17
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=5.95]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.52it/s, valid_loss=3.71]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 17
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 18
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=5.8]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.64it/s, valid_loss=3.67]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 18
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 19
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.43it/s, lr=0.001, train_loss=5.65]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.56it/s, valid_loss=3.63]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 19
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=5.51]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.29it/s, valid_loss=3.61]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 20
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 21
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.44it/s, lr=0.001, train_loss=5.4]
100%|███████████████████████████| 50/50 [00:07&lt;00:00,  6.53it/s, valid_loss=3.6]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 21
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 22
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=5.3]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.57it/s, valid_loss=3.58]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 22
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 23
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=5.21]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.57it/s, valid_loss=3.55]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 23
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 24
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=5.15]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.52it/s, valid_loss=3.55]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 24
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=5.08]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.57it/s, valid_loss=3.54]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 25
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 26
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.45it/s, lr=0.001, train_loss=5.02]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.31it/s, valid_loss=3.53]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 26
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 27
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:35&lt;00:00,  1.43it/s, lr=0.001, train_loss=4.96]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.54it/s, valid_loss=3.49]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 27
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 28
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=4.89]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.59it/s, valid_loss=3.52]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 1 out of 5
Epoch: 29
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=4.84]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.58it/s, valid_loss=3.47]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 29
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 30
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:33&lt;00:00,  1.47it/s, lr=0.001, train_loss=4.77]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.59it/s, valid_loss=3.46]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 30
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 31
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=4.71]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.56it/s, valid_loss=3.47]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 1 out of 5
Epoch: 32
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:35&lt;00:00,  1.41it/s, lr=0.001, train_loss=4.65]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.43it/s, valid_loss=3.43]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best loss at Epoch: 32
Validation loss decreased. Saving model to prostate cancer dataset/saved_weights/itr_01Bleep+optimus_prostate_pathways_MEND161.pt
Epoch: 33
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.44it/s, lr=0.001, train_loss=4.58]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.38it/s, valid_loss=3.46]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 1 out of 5
Epoch: 34
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.44it/s, lr=0.001, train_loss=4.49]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.53it/s, valid_loss=3.45]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 2 out of 5
Epoch: 35
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=4.41]
100%|███████████████████████████| 50/50 [00:07&lt;00:00,  6.58it/s, valid_loss=3.5]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 3 out of 5
Epoch: 36
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████| 50/50 [00:34&lt;00:00,  1.46it/s, lr=0.001, train_loss=4.31]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.58it/s, valid_loss=3.45]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 4 out of 5
Epoch: 37
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 50/50 [00:34&lt;00:00,  1.47it/s, lr=0.001, train_loss=4.2]
100%|██████████████████████████| 50/50 [00:07&lt;00:00,  6.57it/s, valid_loss=3.55]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
EarlyStopping counter: 5 out of 5
Early stopping
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<section id="Testing">
<h1>Testing<a class="headerlink" href="#Testing" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_predictions</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">model_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished loading model&quot;</span><span class="p">)</span>

    <span class="n">test_image_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_expression_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">optim_feat</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;st_feat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;reduced_expression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">model_tag</span><span class="o">==</span><span class="s2">&quot;BLEEPOnly&quot;</span><span class="p">:</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">image_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                <span class="n">image_embeddings</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">image_projection</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span>
                <span class="n">expression_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spot_projection</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">model_tag</span><span class="o">==</span><span class="s2">&quot;BLEEPWithOptimus&quot;</span><span class="p">:</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">image_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">image_features</span><span class="p">,</span> <span class="n">optim_feat</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">image_embeddings</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">image_projection</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span>
                <span class="n">expression_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spot_projection</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">model_tag</span><span class="o">==</span><span class="s2">&quot;DeepPathway&quot;</span><span class="p">:</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">image_model</span><span class="o">.</span><span class="n">image_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">image_features</span><span class="p">,</span> <span class="n">optim_feat</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">image_model</span><span class="o">.</span><span class="n">image_projection</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span>
                <span class="n">image_embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">img_linear</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span> <span class="c1"># here it is direct prediction</span>
                <span class="n">expression_embedding</span><span class="o">=</span><span class="n">expression</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">image_model</span><span class="o">.</span><span class="n">image_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                <span class="n">image_embeddings</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">image_model</span><span class="o">.</span><span class="n">image_projection</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span>
                <span class="n">image_embeddings</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">img_linear</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span>
                <span class="n">expression_embedding</span><span class="o">=</span><span class="n">expression</span>   <span class="c1"># just to avoid errors, pasted the same GT expression.</span>
            <span class="n">test_image_embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_embeddings</span><span class="p">)</span>
            <span class="n">test_expression_embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expression_embedding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">test_image_embeddings</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">test_expression_embeddings</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_weighted_expression</span><span class="p">(</span><span class="n">image_query</span><span class="p">,</span><span class="n">expression_gt</span><span class="p">,</span><span class="n">spot_key</span><span class="p">,</span><span class="n">expression_key</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">image_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">:</span>
        <span class="n">image_query</span> <span class="o">=</span> <span class="n">image_query</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image query shape: &quot;</span><span class="p">,</span> <span class="n">image_query</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expression_gt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">image_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">expression_gt</span> <span class="o">=</span> <span class="n">expression_gt</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expression_gt shape: &quot;</span><span class="p">,</span> <span class="n">expression_gt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">:</span>
        <span class="n">spot_key</span> <span class="o">=</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spot_key shape: &quot;</span><span class="p">,</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expression_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">expression_key</span> <span class="o">=</span> <span class="n">expression_key</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expression_key shape: &quot;</span><span class="p">,</span> <span class="n">expression_key</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">find_matches</span><span class="p">(</span><span class="n">spot_key</span><span class="p">,</span> <span class="n">image_query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">matched_spot_embeddings_pred</span> <span class="o">=</span> <span class="n">spot_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot embeddings pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_embeddings_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">matched_spot_expression_pred</span> <span class="o">=</span> <span class="n">expression_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot expression pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_expression_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finding matches, using average of top 10 expressions&quot;</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">find_matches</span><span class="p">(</span><span class="n">spot_key</span><span class="p">,</span> <span class="n">image_query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">matched_spot_embeddings_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">matched_spot_expression_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expression_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># print(i)</span>
            <span class="n">matched_spot_embeddings_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">spot_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">matched_spot_expression_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expression_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot embeddings pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_embeddings_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot expression pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_expression_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;weighted_average&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finding matches, using weighted average of top 50 expressions&quot;</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">find_matches</span><span class="p">(</span><span class="n">spot_key</span><span class="p">,</span> <span class="n">image_query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">matched_spot_embeddings_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">matched_spot_expression_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expression_key</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">spot_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">image_query</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># the smallest MSE</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">spot_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">image_query</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weights: &quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
            <span class="n">matched_spot_embeddings_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">spot_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">matched_spot_expression_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expression_key</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot embeddings pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_embeddings_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matched spot expression pred shape: &quot;</span><span class="p">,</span> <span class="n">matched_spot_expression_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">true</span> <span class="o">=</span> <span class="n">expression_gt</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">matched_spot_expression_pred</span>
    <span class="k">return</span> <span class="n">pred</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_predicted_expressions</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">root_path</span><span class="p">,</span><span class="n">img_embeddings_all</span><span class="p">,</span><span class="n">spot_embeddings_all</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">datasize</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">root_path</span><span class="o">+</span><span class="s2">&quot;pathway expression/&quot;</span><span class="o">+</span><span class="n">each</span><span class="o">+</span><span class="s2">&quot;_pathway expression.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">datasize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">datasize</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">datasize</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">image_embeddings</span> <span class="o">=</span> <span class="n">img_embeddings_all</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">spot_embeddings</span> <span class="o">=</span> <span class="n">spot_embeddings_all</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s2">&quot;img_embeddings_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">image_embeddings</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s2">&quot;spot_embeddings_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">spot_embeddings</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">expression_key</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spot_key</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">root_path</span><span class="o">+</span><span class="s2">&quot;spot_embeddings_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">image_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s2">&quot;img_embeddings_1.npy&quot;</span><span class="p">)</span>
    <span class="n">expression_gt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">expression_pred</span> <span class="o">=</span> <span class="n">get_weighted_expression</span><span class="p">(</span><span class="n">image_query</span><span class="p">,</span><span class="n">expression_gt</span><span class="p">,</span><span class="n">spot_key</span><span class="p">,</span><span class="n">expression_key</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression_pred</span>

<span class="k">def</span><span class="w"> </span><span class="nf">find_matches</span><span class="p">(</span><span class="n">spot_embeddings</span><span class="p">,</span> <span class="n">query_embeddings</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># find the closest matches</span>
    <span class="n">spot_embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">spot_embeddings</span><span class="p">)</span>
    <span class="n">query_embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">)</span>
    <span class="n">query_embeddings</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spot_embeddings</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">spot_embeddings</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dot_similarity</span> <span class="o">=</span> <span class="n">query_embeddings</span> <span class="o">@</span> <span class="n">spot_embeddings</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># 2277x2265</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dot_similarity</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dot_similarity</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">metrics_calculation</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">pred</span><span class="p">):</span>
    <span class="n">corr_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sp_corr_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cosine_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">corr_cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sp_corr_cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cosine_cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

    <span class="n">corr_cells</span> <span class="o">=</span> <span class="n">corr_cells</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr_cells</span><span class="p">)]</span>
    <span class="n">sp_corr_cells</span> <span class="o">=</span> <span class="n">sp_corr_cells</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp_corr_cells</span><span class="p">)]</span>
    <span class="n">cosine_cells</span> <span class="o">=</span> <span class="n">cosine_cells</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cosine_cells</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Pearson correlation across All spots (pathwaywuse correlation): &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_cells</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Spearman correlation across spots: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp_corr_cells</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Cosine Similarity across spots: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cosine_cells</span><span class="p">))</span>

    <span class="n">corr_pathways</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sp_corr_paths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cosine_pathways</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">corr_pathways</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">true</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sp_corr_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">true</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cosine_pathways</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">true</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">true</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>

    <span class="n">corr_pathways</span> <span class="o">=</span> <span class="n">corr_pathways</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr_pathways</span><span class="p">)]</span>
    <span class="n">sp_corr_paths</span> <span class="o">=</span> <span class="n">sp_corr_paths</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp_corr_paths</span><span class="p">)]</span>
    <span class="n">cosine_pathways</span> <span class="o">=</span> <span class="n">cosine_pathways</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cosine_pathways</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Pearson correlation across pathways: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_pathways</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Spearman correlation across pathways: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp_corr_paths</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Cosine Similarity across pathways: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cosine_pathways</span><span class="p">))</span>
    <span class="n">true_filetered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">corr_pathways</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">corr_pathways</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true_filetered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
    <span class="n">true_filetered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_filetered</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">true_filetered</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">true_filetered</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="c1"># print(&quot;highly expressed indices&quot;,ind)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mean Pearson correlation highly expressed pathways: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_pathways</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="c1"># print(&quot;mean Spearman correlation highly expressed pathways: &quot;, np.mean(sp_corr_paths[ind]))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">true_filetered</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="c1"># print(&quot;highly variable indices&quot;,ind)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mean Pearson correlation highly variable pathways: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_pathways</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="c1"># print(&quot;mean Spearman correlation highly variable pathways: &quot;, np.mean(sp_corr_paths[ind]))</span>
    <span class="k">return</span>

<span class="k">def</span><span class="w"> </span><span class="nf">copy_adata</span><span class="p">(</span><span class="n">adata_true</span><span class="p">,</span><span class="n">adata_pred</span><span class="p">):</span>
    <span class="n">adata_pred</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata_true</span><span class="o">.</span><span class="n">obs</span>
    <span class="n">adata_pred</span><span class="o">.</span><span class="n">uns</span> <span class="o">=</span> <span class="n">adata_true</span><span class="o">.</span><span class="n">uns</span>
    <span class="n">adata_pred</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">adata_true</span><span class="o">.</span><span class="n">var_names</span>
    <span class="n">adata_pred</span><span class="o">.</span><span class="n">obsm</span> <span class="o">=</span> <span class="n">adata_true</span><span class="o">.</span><span class="n">obsm</span>
    <span class="k">return</span> <span class="n">adata_pred</span>

<span class="k">def</span><span class="w"> </span><span class="nf">contains_nan</span><span class="p">(</span><span class="n">sublist</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_top_k_pathways</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">pred</span><span class="p">,</span><span class="n">pathway_names</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">top_pathways</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">true</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
    <span class="n">cleaned_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">sublist</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">contains_nan</span><span class="p">(</span><span class="n">sublist</span><span class="p">)]</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cleaned_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
        <span class="n">top_pathways</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathway_names</span><span class="p">[</span><span class="n">sorted_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">top_pathways</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;MEND154&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span>  <span class="o">+</span> <span class="s2">&quot;itr_01_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span> <span class="o">+</span> <span class="s2">&quot;_pathways_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/home/e90244aa/Bleep/DeepPathwayV2/prostate cancer dataset/itr_01_DeepPathway_prostate_pathways_MEND154.pt
</pre></div></div>
</div>
<section id="Using-BLEEP+Optimus">
<h2>Using BLEEP+Optimus<a class="headerlink" href="#Using-BLEEP+Optimus" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sdata</span> <span class="o">=</span> <span class="n">read_zarr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="o">+</span><span class="s2">&quot;SpatialData/&quot;</span><span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="o">+</span><span class="s2">&quot;_spatial_data.zarr&quot;</span><span class="p">)</span>
<span class="n">true</span><span class="o">=</span><span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
<span class="n">data_list</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">train_samples</span>
<span class="n">data_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders_inference</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span>  <span class="o">+</span> <span class="s2">&quot;itr_01_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span> <span class="o">+</span> <span class="s2">&quot;_pathways_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BLEEPWithOptimus</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
<span class="n">image_embeddings_all</span><span class="p">,</span> <span class="n">spot_embeddings_all</span> <span class="o">=</span> <span class="n">get_predictions</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">model_tag</span><span class="o">=</span><span class="s2">&quot;BLEEPWithOptimus&quot;</span><span class="p">)</span>
<span class="n">image_embeddings_all</span><span class="o">=</span> <span class="n">image_embeddings_all</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">spot_embeddings_all</span>  <span class="o">=</span> <span class="n">spot_embeddings_all</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">get_predicted_expressions</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">image_embeddings_all</span><span class="p">,</span> <span class="n">spot_embeddings_all</span><span class="p">,</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span><span class="p">)</span>
<span class="n">adata_preds</span> <span class="o">=</span> <span class="n">copy_adata</span><span class="p">(</span><span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">],</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">pred</span><span class="p">))</span>
<span class="n">method</span><span class="o">=</span><span class="nb">str</span><span class="p">()</span>
<span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span>
<span class="n">sdata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;predictions_&#39;</span> <span class="o">+</span> <span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_preds</span>
<span class="c1"># sdata.write(cfg.root_path + &quot;/SpatialData/&quot; + cfg.test_sample + &quot;_spatial_data.zarr&quot;, overwrite=True)</span>
<span class="n">metrics_calculation</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>
<span class="n">top_k_pathways</span> <span class="o">=</span> <span class="n">get_top_k_pathways</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot_sdata</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="p">,</span><span class="n">top_k_pathway_names</span><span class="o">=</span><span class="n">top_k_pathways</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Building loaders
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished loading all files
Finished building inference loaders
Finished loading model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████| 75/75 [00:43&lt;00:00,  1.74it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
image query shape:  (2546, 256)
spot_key shape:  (16419, 256)
expression_key shape:  (16419, 47)
finding matches, using average of top 10 expressions
torch.Size([2546, 16419])
matched spot embeddings pred shape:  (2546, 256)
matched spot expression pred shape:  (2546, 47)
Mean Pearson correlation across All spots (pathwaywuse correlation):  0.6418895296194997
Mean Spearman correlation across spots:  0.6097861716382801
Mean Cosine Similarity across spots:  0.9673386512877976
Mean Pearson correlation across pathways:  0.18149508998370276
Mean Spearman correlation across pathways:  0.1804258102283013
Mean Cosine Similarity across pathways:  0.9611844837635597
(2546, 47)
mean Pearson correlation highly expressed pathways:  0.1631613384513791
mean Pearson correlation highly variable pathways:  0.20032227107044748
<span class="ansi-blue-fg">INFO    </span> Transposing `data` of type: <span class="ansi-bold">&lt;</span><span class="ansi-magenta-intense-fg ansi-bold">class</span> <span class="ansi-green-fg">&#39;dask.array.core.Array&#39;</span><span class="ansi-bold">&gt;</span> to <span class="ansi-bold">(</span><span class="ansi-green-fg">&#39;c&#39;</span>, <span class="ansi-green-fg">&#39;y&#39;</span>, <span class="ansi-green-fg">&#39;x&#39;</span><span class="ansi-bold">)</span>.
AnnData object with n_obs × n_vars = 2546 × 47
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;pxl_row_in_fullres&#39;, &#39;pxl_col_in_fullres&#39;, &#39;region&#39;, &#39;spot_id&#39;
    uns: &#39;spatialdata_attrs&#39;
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_training_14_14.png" src="../_images/tutorials_training_14_14.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_training_14_15.png" src="../_images/tutorials_training_14_15.png" />
</div>
</div>
</section>
<section id="Using-DeepPathway">
<h2>Using DeepPathway<a class="headerlink" href="#Using-DeepPathway" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sdata</span> <span class="o">=</span> <span class="n">read_zarr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="o">+</span><span class="s2">&quot;SpatialData/&quot;</span><span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="o">+</span><span class="s2">&quot;_spatial_data.zarr&quot;</span><span class="p">)</span>
<span class="n">true</span><span class="o">=</span><span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders_inference</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="p">],</span> <span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">root_path</span>  <span class="o">+</span> <span class="s2">&quot;itr_01_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span> <span class="o">+</span> <span class="s2">&quot;_pathways_&quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DeepPathway</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
<span class="n">pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_predictions</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">model_tag</span><span class="o">=</span><span class="s2">&quot;DeepPathway&quot;</span><span class="p">)</span>
<span class="n">pred</span>  <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">adata_preds</span> <span class="o">=</span> <span class="n">copy_adata</span><span class="p">(</span><span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">],</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">pred</span><span class="p">))</span>
<span class="n">method</span><span class="o">=</span><span class="nb">str</span><span class="p">()</span>
<span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">method</span>
<span class="n">sdata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;predictions_&#39;</span> <span class="o">+</span> <span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_preds</span>
<span class="c1"># sdata.write(cfg.root_path + &quot;/SpatialData/&quot; + cfg.test_sample + &quot;_spatial_data.zarr&quot;, overwrite=True)</span>
<span class="n">metrics_calculation</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>
<span class="n">top_k_pathways</span> <span class="o">=</span> <span class="n">get_top_k_pathways</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">sdata</span><span class="p">[</span><span class="s1">&#39;adata_pathways&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot_sdata</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">test_sample</span><span class="p">,</span><span class="n">top_k_pathway_names</span><span class="o">=</span><span class="n">top_k_pathways</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Building loaders
Finished loading all files
Finished building inference loaders
Finished loading model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████| 10/10 [00:05&lt;00:00,  1.69it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mean Pearson correlation across All spots (pathwaywuse correlation):  0.6583747062189815
Mean Spearman correlation across spots:  0.6131214388327076
Mean Cosine Similarity across spots:  0.96943441959089
Mean Pearson correlation across pathways:  0.08722968251740582
Mean Spearman correlation across pathways:  0.07952614200581999
Mean Cosine Similarity across pathways:  0.960669396064665
(2546, 47)
mean Pearson correlation highly expressed pathways:  0.14762142231134293
mean Pearson correlation highly variable pathways:  0.04423980363264539
<span class="ansi-blue-fg">INFO    </span> Transposing `data` of type: <span class="ansi-bold">&lt;</span><span class="ansi-magenta-intense-fg ansi-bold">class</span> <span class="ansi-green-fg">&#39;dask.array.core.Array&#39;</span><span class="ansi-bold">&gt;</span> to <span class="ansi-bold">(</span><span class="ansi-green-fg">&#39;c&#39;</span>, <span class="ansi-green-fg">&#39;y&#39;</span>, <span class="ansi-green-fg">&#39;x&#39;</span><span class="ansi-bold">)</span>.
AnnData object with n_obs × n_vars = 2546 × 47
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;pxl_row_in_fullres&#39;, &#39;pxl_col_in_fullres&#39;, &#39;region&#39;, &#39;spot_id&#39;
    uns: &#39;spatialdata_attrs&#39;
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_true` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-fg">INFO    </span> Rasterizing image for faster rendering.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:105: UserWarning: Key `spots` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
/home/e90244aa/anaconda3/envs/bleep_env/lib/python3.10/site-packages/spatialdata/_core/_elements.py:125: UserWarning: Key `adata_pred` already exists. Overwriting it in-memory.
  self._check_key(key, self.keys(), self._shared_keys)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_training_16_14.png" src="../_images/tutorials_training_16_14.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_training_16_15.png" src="../_images/tutorials_training_16_15.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data_processing.html" class="btn btn-neutral float-left" title="This tutorial provides the data processing of the ST datasets. Plase update and save the config.py file as following." accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Usage.html" class="btn btn-neutral float-right" title="Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Muhammad Ahtazaz Ahsan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>